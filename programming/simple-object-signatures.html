<!doctype html>
<html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=description content="Gaël Varoquaux, computer / data / brain science"><link rel=alternate href=http://gael-varoquaux.info/feeds/all.atom.xml type=application/atom+xml title="Gaël Varoquaux Full Atom Feed"><title>Simple object signatures -- Gaël Varoquaux: computer / data / brain science</title><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css><link rel=stylesheet href=../theme/css/pure.css><script src=//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js></script></head><body><div class=pure-g-r id=layout><div class="sidebar sidebar-article pure-u"><header class=header-article><hgroup><a href=..><img class=avatar alt="Gaël Varoquaux" src=http://gael-varoquaux.info/images/gael.png></a><a href=.. class=article-info><h2 class=article-info>Gaël Varoquaux</h2></a><p>Fri 16 July 2010</p><a href=/>&larr;Home</a></hgroup></header></div><div class=pure-u><div class=content><section class=post><header class=post-header><h1>Simple object signatures</h1><p class=post-meta> under <a class=post-category href=../tag/software-engineering.html>software engineering</a><a class=post-category href=../tag/software-architecture.html>software architecture</a><a class=post-category href=../tag/design-patterns.html>design patterns</a><a class=post-category href=../tag/scientific-computing.html>scientific computing</a><a class=post-category href=../tag/selected.html>selected</a><span class=social_links><a href=http://twitter.com/share class=twitter-share-button data-count=horizontal data-via=GaelVaroquaux>Tweet</a><script type=text/javascript src=http://platform.twitter.com/widgets.js async defer></script><span class=g-plusone data-size=medium></span></span></p></header></section><div class=section id=a-signature-pattern><h2>A <em>signature</em> pattern</h2><p>There are many libraries around to specify what I call a <em>‘signature’</em> for an object, in other words a list of attributes that define its parameter set. I have heavily used <a class="reference external" href=http://code.enthought.com/projects/traits>Enthought’s Traits library</a> for this purpose, but the concept is fairly general and can be found <em>eg</em> in ORMs (Object Relational Mappers) or web frameworks.</p><p>Specification of this interface of parameters may be used to answer a variety of needs:</p><ul class=simple><li><strong>Typing</strong>: in the case of an ORM, to generate UIs, or for better error management, it may be desirable to have some control on the types of certain attributes of an object. In this case, specifying the signature corresponds to laying out a <strong>data model</strong> for the object.</li><li><strong>Reactive programming</strong>: using properties to react to changes to attributes, one can fully specify the API of an object in terms of these attributes. This gives a message-passing like programming style that can be very well suited to parallel-computing in particular because it can easily be made thread-safe.</li></ul></div><div class=section id=signatures-for-statistical-learning-objects><h2>Signatures for statistical learning objects</h2><p>Recently, I considered the <em>signature</em> pattern in a new context. In the <a class="reference external" href=http://scikit-learn.sourceforge.net/>scikit-learn</a>, we are interested in statistical learning. This entails fitting models to data and often tuning parameters to select a model that fits best (a problem called <em>model selection</em>). Each of our models is an object that implements a couple of key methods to fit to the data and to apply to new data (<em>fit</em> and <em>predict</em>).</p><p>The approach that we are currently taking for model selection is (more or less) to generate a list of models with different parameters and fit and test them on the data.</p><p>A very nice feature would be to find out the parameters to vary simply by inspecting the objects, and such a desire recently got us <a class="reference external" href="http://sourceforge.net/mailarchive/forum.php?thread_name=201007050958.16199.matthieu.perrot%40cea.fr&amp;forum_name=scikit-learn-general">discussing</a> of defining <em>signatures</em> for our objects. I must confess that I am a bit weary as this means either depending on a signature library, or building one. We don’t want to grow our dependencies, and most signature-definition code that I know involve meta-programming tricks to avoid code duplication.</p></div><div class=section id=solving-the-simple-problem-avoiding-type-checking><h2>Solving the simple problem: avoiding type checking</h2><p>Today, I had to bite the bullet, because we were in a situation in which we had to instantiate new models from the existing one during model selection. For technical reasons, using a <em>copy.copy</em> to create these new models was not a great idea, and it was better to have the minimal list of parameters required. Here come signatures again.</p><p>After a bit of messing around with the code, I realized that typing information was useless, and most probably harmful, to our immediate goals and that I just needed the names of the relevant attributes. I finally settled down to the following solution (which might still change):</p><ul class=simple><li>All parameters need to be specified as keyword arguments of the <em>__init__</em>. The <em>__init__</em> may not have positional arguments or ‘*’ arguments. Attributes on the objects have the same names as the <em>__init__</em> parameters.</li><li>A simple base class, with couple of methods relying on a simple use of the <em>inspect</em> module to find the signature of the <em>__init__</em>.</li></ul><hr class=docutils><div class=highlight><pre><span></span><span class=k>class</span> <span class=nc>BaseEstimator</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
    <span class=nd>@classmethod</span>
    <span class=k>def</span> <span class=nf>_get_param_names</span><span class=p>(</span><span class=n>cls</span><span class=p>):</span>
        <span class=n>args</span><span class=p>,</span> <span class=n>varargs</span><span class=p>,</span> <span class=n>kw</span><span class=p>,</span> <span class=n>default</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>getargspec</span><span class=p>(</span><span class=n>cls</span><span class=o>.</span><span class=n>__init__</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>varargs</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>,</span> <span class=p>(</span>
            <span class=s1>&#39;scikit learn estimators should always specify their &#39;</span>
            <span class=s1>&#39;parameters in the signature of their init (no varargs).&#39;</span>
            <span class=p>)</span>
        <span class=c1># Remove &#39;self&#39;</span>
        <span class=n>args</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>args</span>

    <span class=k>def</span> <span class=nf>_get_params</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>out</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_param_names</span><span class=p>():</span>
            <span class=n>out</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>out</span>

    <span class=k>def</span> <span class=nf>_set_params</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>params</span><span class=p>):</span>
        <span class=n>valid_params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_param_names</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>params</span><span class=o>.</span><span class=n>iteritems</span><span class=p>():</span>
            <span class=k>assert</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>valid_params</span><span class=p>,</span> <span class=p>(</span><span class=s1>&#39;Invalid parameter </span><span class=si>%s</span><span class=s1> &#39;</span>
                <span class=s1>&#39;for estimator </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span>
                <span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>__class__</span><span class=o>.</span><span class=n>__name__</span><span class=p>))</span>
            <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</pre></div><p>The full code can be seen <a class="reference external" href=attachments/base_estimator.py>here</a> and adds a bit more features, such as a clever <em>__repr__</em>.</p><p>What I like about this solution is that it (almost) does not use metaprograming, and avoids code duplication without forcing any specific pattern on the developer subclassing <em>BaseEstimator</em>.</p></div><div class=section id=the-next-step><h2>The next step</h2><p>This approach solves my immediate problem, but not the bigger one of finding what values can the different parameters take when varied for model selection. Of course this second problem is much more complicated, and maybe it is not worth solving it: the framework could very easily be bringing in more problems than it solves.</p><p>However, it seems that a fairly easy way of specifying possible values for parameters would be to decorate the <em>__init__</em>, giving the possible parameters to be tested during the model selection:</p><div class=highlight><pre><span></span><span class=nd>@cv_params</span><span class=p>(</span><span class=n>l1</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>logspace</span><span class=p>(</span><span class=mf>1e-4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
<span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>l1</span><span class=o>=.</span><span class=mi>5</span><span class=p>,</span> <span class=n>fit_intercept</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
<span class=c1># ...</span>
</pre></div><p>All the decorator has to do is to store the information in an attribute attached to the <em>__init__</em> (and probably to check that the parameters it was given are valid arguments, in order to raise errors early). Methods on the class can later inspect this information for model selection, or GUI building (data-model specification will probably require some typing language, rather than a simple list of possible parameters).</p><p>Once again, here we would be avoiding the difficulty of specifying type information in a non restrictive way, but avoiding a problem that we don’t have to solve is probably a good idea.</p></div><div class=hr style="margin-bottom: -.5em;"></div><span class=social_links><a href=http://twitter.com/share class=twitter-share-button data-count=horizontal data-via=GaelVaroquaux>Tweet</a><script type=text/javascript src=http://platform.twitter.com/widgets.js async defer></script><span class=g-plusone data-size=medium></span></span><a href=# class=go-top>Go Top</a><div class=comments><div id=disqus_thread></div><script type=text/javascript>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "gaelvaroquaux"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer class=footer><p>&copy; Gaël Varoquaux &ndash; Built with <a href=https://github.com/PurePelicanTheme/pure>Pure Theme</a> for <a href=http://blog.getpelican.com/>Pelican</a></p></footer></div></div></div><script src=//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js></script><script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script><script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script><script src=https://apis.google.com/js/platform.js async defer></script><script type=text/javascript>
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type=text/javascript>
        try {
            var pageTracker = _gat._getTracker("UA-55589822-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script></body></html>